<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section [
<!-- Useful for describing APIs -->
<!ENTITY POST   '<command xmlns="http://docbook.org/ns/docbook">POST</command>'>
]>
<section xmlns="http://docbook.org/ns/docbook"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns:m="http://www.w3.org/1998/Math/MathML"
    xmlns:html="http://www.w3.org/1999/xhtml"
    xmlns:db="http://docbook.org/ns/docbook" version="5.0"
    xml:id="object-storage-form-post">
    <title>Form POST middleware</title>
    <section xml:id="form-post-overview">
        <?dbhtml stop-chunking?>
        <title>Overview</title>
        <para>You can upload objects directly to the Object Storage
            system from a browser by using the form &POST; middleware.
            This middleware uses account secret keys to generate a
            cryptographic signature for the request. This means that
            you do not need to send an authentication token in the
                <literal>X-Auth-Token</literal> header to perform the
            request.</para>
        <para>For information about the form &POST; middleware
            configuration options, see <link
                xlink:href="http://docs.openstack.org/havana/config-reference/content/object-storage-form-post.html"
                    ><citetitle>OpenStack Configuration
                    Reference</citetitle></link>.</para>
        <para>The form &POST; middleware uses the same secret keys as
            the temporary URL middleware uses. For information about
            how to set these keys, see <xref
                linkend="account-secret-keys-temp-url"/>.</para>
        <section xml:id="form-post-format">
            <title>Form POST format</title>
            <para>To upload objects to a cluster, you can use an HTML
                form &POST; request.</para>
            <para>The format of the form &POST; request is:</para>
            <example xml:id="formpost-example">
                <title>Form POST format</title>
                <programlistingco>
                    <areaspec>
                        <area xml:id="formpost.txt.action"
                            units="linecolumn" coords="2 26"/>
                        <area xml:id="formpost.txt.method"
                            units="linecolumn" coords="3 19"/>
                        <area xml:id="formpost.txt.enctype"
                            units="linecolumn" coords="4 36"/>
                        <area xml:id="formpost.txt.redirect"
                            units="linecolumn" coords="5 65"/>
                        <area xml:id="formpost.txt.max_file_size"
                            units="linecolumn" coords="6 63"/>
                        <area xml:id="formpost.txt.max_file_count"
                            units="linecolumn" coords="7 64"/>
                        <area xml:id="formpost.txt.expires"
                            units="linecolumn" coords="8 66"/>
                        <area xml:id="formpost.txt.signature"
                            units="linecolumn" coords="9 58"/>
                        <area xml:id="formpost.txt.file"
                            units="linecolumn" coords="10 39"/>
                        <area xml:id="formpost.txt.submit"
                            units="linecolumn" coords="12 28"/>
                    </areaspec>
                    <programlisting language="bash"><xi:include href="samples/formpost.txt" parse="text"/></programlisting>
                </programlistingco>
            </example>
            <para>The example, <xref linkend="formpost-example"/>,
                shows these attributes: </para>
            <calloutlist>
                <callout arearefs="formpost.txt.action">
                    <para><emphasis role="bold"
                                   ><literal>action="<replaceable>SWIFT_URL</replaceable>"</literal></emphasis>
                    </para>
                    <para>Set to full URL where the objects are to be
                        uploaded. The names of uploaded files are
                        appended to the specified
                            <replaceable>SWIFT_URL</replaceable>. So,
                        you can upload directly to the root of a
                        container with a URL like:</para>
                    <screen><userinput>https://swift-cluster.example.com/v1/my_account/container/</userinput></screen>
                    <para>Optionally, you can include an object prefix
                        to separate uploads, such as:</para>
                    <screen><userinput>https://swift-cluster.example.com/v1/my_account/container/<replaceable>OBJECT_PREFIX</replaceable></userinput></screen>
                </callout>
                <callout arearefs="formpost.txt.method">
                    <para><emphasis role="bold"
                            >method="POST"</emphasis></para>
                    <para>Must be <literal>POST</literal>.</para>
                </callout>
                <callout arearefs="formpost.txt.enctype">
                    <para><emphasis role="bold"
                            >enctype="multipart/form-data"</emphasis></para>
                    <para>Must be
                            <literal>multipart/form-data</literal>.</para>
                </callout>
                <callout arearefs="formpost.txt.redirect">
                    <para><emphasis role="bold">name="redirect"
                                value="<replaceable>REDIRECT_URL</replaceable>"</emphasis></para>
                    <para>Redirects the browser to the
                            <replaceable>REDIRECT_URL</replaceable>
                        after the upload completes. The URL has status
                        and message query parameters added to it,
                        which specify the HTTP status code for the
                        upload and an optional error message. The
                            2<replaceable>nn</replaceable> status code
                        indicates success.</para>
                    <para> The <replaceable>REDIRECT_URL</replaceable>
                        can be an empty string. If so, the
                            <literal>Location</literal> response
                        header is not set.</para>
                </callout>
                <callout arearefs="formpost.txt.max_file_size">
                    <para><emphasis role="bold">name="max_file_size"
                                value="<replaceable>BYTES</replaceable>"</emphasis></para>
                    <para>Required. Indicates the size, in bytes, of
                        the maximum single file upload.</para>
                </callout>
                <callout arearefs="formpost.txt.max_file_count">
                    <para><emphasis role="bold">name="max_file_count"
                            value=
                            "<replaceable>COUNT</replaceable>"</emphasis></para>
                    <para>Required. Indicates the maximum number of
                        files that can be uploaded with the form.
                    </para>
                </callout>
                <callout arearefs="formpost.txt.expires">
                    <para><emphasis role="bold">name="expires"
                                value="<replaceable>UNIX_TIMESTAMP</replaceable>"</emphasis></para>
                    <para>The UNIX timestamp that specifies the time
                        before which the form must be submitted before
                        it becomes no longer valid.</para>
                </callout>
                <callout arearefs="formpost.txt.signature">
                    <para><emphasis role="bold">name="signature"
                                value="<replaceable>HMAC</replaceable>"</emphasis></para>
                    <para>The HMAC-SHA1 signature of the form. See
                            <xref linkend="signature"/>.</para>
                </callout>
                <callout arearefs="formpost.txt.file">
                    <para><emphasis role="bold">type="file"
                                name="<replaceable>FILE_NAME</replaceable>"</emphasis></para>
                    <para>File name of the file to be uploaded. You
                        can include from one to the
                            <literal>max_file_count</literal> value of
                        files. </para>
                    <para>The file attributes must appear <emphasis
                            role="italic">after</emphasis> the other
                        attributes to be processed correctly.</para>
                    <para>If attributes appear after the file
                        attributes, they are not sent with the
                        sub-request because all attributes in the file
                        cannot be parsed on the server side unless the
                        whole file is read into memory; the server
                        does not have enough memory to service these
                        requests. Attributes that follow the file
                        attributes are ignored.</para>
                </callout>
                <callout arearefs="formpost.txt.submit">
                    <para><emphasis role="bold">type=
                            "submit"</emphasis></para>
                    <para>Must be <literal>submit</literal>.</para>
                </callout>
            </calloutlist>
        </section>
    </section>
    <section xml:id="form-post-curl">
        <title>Use form POST</title>
        <para>The following example shows how to submit a form by
            using a cURL command. In this example, the object prefix
            is <literal>photos/</literal> and the file being uploaded
            is called <filename>flower.jpg</filename>. </para>
        <para>This example uses the
                <command>swift-form-signature</command> script to
            compute the <literal>expires</literal> and
                <literal>signature</literal> values.</para>
        <screen><prompt>$</prompt> <userinput>bin/swift-form-signature /v1/my_account/container/photos/ https://example.com/done.html 5373952000 1 200 mykey
            Expires: 1390825338
            Signature: 35129416ebda2f1a21b3c2b8939850dfc63d8f43</userinput></screen>
        <screen><prompt>$</prompt> <userinput>curl -i https://swift-cluster.example.com/v1/my_account/container/photos/ -X POST \
            -F max_file_size=5373952000 -F max_file_count=1 -F expires=1390825338 \
            -F signature=35129416ebda2f1a21b3c2b8939850dfc63d8f43 \
            -F redirect=https://example.com/done.html \
            -F file=@flower.jpg</userinput></screen>
        <para>Include the full path, from the <literal>/v1/</literal>
            onward.</para>
        <para>For more information about how to generate a signature,
            see <xref linkend="signature"/>.</para>
    </section>
</section>
